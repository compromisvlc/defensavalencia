<!doctype html>
<html lang="ca">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Al·legacions València — Generador PDF</title>
    <meta name="description" content="Miniapp per generar un PDF d'al·legacions sobre el canvi de denominació del municipi de València." />
    <!-- jsPDF (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
    <style>
      :root{
        --orange:#f97316;
        --orange-dark:#ea580c;
        --orange-ink:#9a3412;
        --bg:#fff;
        --text:#353949;
        --muted:#6b7280;
        --ok:#166534;
        --error:#b91c1c;
        --ring:#fed7aa;
        --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background:linear-gradient(135deg, #d23517, #f39128);
        color:#353949;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        display:flex;
        flex-direction:column;
        align-items:center;
        padding:24px;
        min-height:100vh;
      }
      .logo{
        display:block;
        max-width:300px;
        height:auto;
        margin:0 auto 2rem;
      }
      .card{
        width:100%;
        max-width: 720px;
        background:var(--bg);
        border-radius: var(--radius);
        padding: 28px;
        box-shadow: 0 10px 30px rgba(0,0,0,.15);
        transition: transform .3s ease, box-shadow .3s ease;
      }
      .card:hover{ transform: translateY(-2px); box-shadow: 0 14px 40px rgba(0,0,0,.18); }
      h1{ margin:.25rem 0 1rem; font-size: clamp(1.25rem, 2vw, 1.5rem); text-align:center }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
      .grid .full{ grid-column: 1 / -1;}
      label{ display:block; font-size:.9rem; font-weight:600; margin-bottom:6px }
      input[type="text"]{
        width:100%;
        padding:10px 12px;
        border:1px solid #d1d5db;
        border-radius:10px;
        outline: none;
        transition: box-shadow .15s, border-color .15s, transform .05s;
      }
      input[type="text"]:focus{
        border-color: var(--orange);
        box-shadow: 0 0 0 4px var(--ring);
      }
      .msg{ font-size:.8rem; margin-top:6px; min-height:1.1em }
      .msg.ok{ color: var(--ok) }
      .msg.err{ color: var(--error) }
      .actions{ margin-top: 14px; display:flex; gap: 10px; flex-wrap: wrap; justify-content:center }
      button, a.btn{
        appearance:none;
        border:0;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight:700;
        color:#fff;
        background: #FF6720;
        cursor:pointer;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        transition: transform .06s ease, filter .2s ease, background .2s ease;
      }
      button:hover, a.btn:hover{ filter: brightness(1.05); }
      button:active, a.btn:active{ transform: translateY(1px); }
      button[disabled]{ background:#9ca3af; cursor:not-allowed }
      .secondary{ background:#111827 }
      .link{
        color: var(--orange-ink);
        font-weight:700;
        text-decoration: underline;
      }
      .status{ text-align:center; margin-top:8px; font-size:.9rem }
      .toast{
        position: fixed;
        left:50%; transform: translateX(-50%);
        bottom: 18px;
        background:#111827;
        color:#fff;
        padding:10px 14px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,.3);
        opacity:0; pointer-events:none;
        transition: opacity .3s ease, transform .3s ease;
      }
      .toast.show{ opacity:1; transform: translate(-50%, -6px); }
      .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
      @media (max-width:640px){ 
        .grid{ grid-template-columns: 1fr; }
        .card{ padding: 20px; }
        body{ padding: 16px; }
      }
      @media (max-width:480px){
        .card{ padding: 16px; }
        h1{ font-size: 1.25rem; }
        body{ padding: 12px; }
      }
    </style>
  </head>
  <body>
    <img src="logo.svg" alt="Logo" class="logo">
    <main class="card" role="main">
      <h1>Crea i baixa ràpidament la teua al·legació contra l'intent de María José Catalá de canviar el nom de València.      </h1>
      <p id="desc2" style="text-align:center; margin-bottom:1.5rem; line-height:1.5; color:#353949; font-size:0.9rem;">
        Com PP i VOX no són capaços de millorar la vida dels valencians i valencianes, només treballen per a crear nous problemes que ens fan perdre identitat, temps i diners. No permetes que canvien l'històric nom valencià de la ciutat per una fòrmula artificial i saltant-se la llei.
      </p>
      <p class="status" id="status" aria-live="polite"></p>
      <form id="form" novalidate>
        <div class="grid">
          <div>
            <label for="nom">Nom</label>
            <input type="text" id="nom" name="nom" autocomplete="given-name" placeholder="Maria" required>
            <div class="msg" id="msg-nom"></div>
          </div>
          <div>
            <label for="cognoms">Cognoms</label>
            <input type="text" id="cognoms" name="cognoms" autocomplete="family-name" placeholder="Pérez Garcia" required>
            <div class="msg" id="msg-cognoms"></div>
          </div>
          <div>
            <label for="dni">DNI</label>
            <input type="text" id="dni" name="dni" inputmode="text" placeholder="12345678Z" required>
            <div class="msg" id="msg-dni"></div>
          </div>
          <div class="full">
            <label for="adreca">Adreça</label>
            <input type="text" id="adreca" name="adreca" autocomplete="street-address" placeholder="C/ Exemples, 1, 46000 València" required>
            <div class="msg" id="msg-adreca"></div>
          </div>
        </div>
        <div class="actions" id="formActions">
          <button type="submit" id="btnGen" disabled>Generar al·legació</button>
        </div>
      </form>
      <div class="status" id="postGen" style="display:none">
        <h2 style="color:#353949; margin-bottom:1rem; text-align:center">Al·legació generada correctament!</h2>
        <p style="text-align:center; margin-bottom:1.5rem">La descàrrega s'ha iniciat automàticament. Si no s'ha baixat, podeu tornar a baixar-la fent clic en l'enllaç de baix.</p>
        <div style="text-align:center; margin-bottom:1.5rem">
          <a id="btnDl" href="#" download style="display:none; color:#d23517; text-decoration:underline; font-weight:500">Tornar a baixar PDF</a>
        </div>
        <div style="display:flex; justify-content:center">
          <a class="btn" href="https://sede.valencia.es/sede/authClave.xhtml/NC.NC.10" target="_blank" rel="noopener">Presentar al·legació</a>
        </div>
      </div>
    </main>
    <div style="text-align:center; margin-top:1rem;">
      <a href="privacy.html" style="color:#353949; text-decoration:underline; font-size:0.85rem;">Política de privacitat</a>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
      // Utilities
      const $ = (sel) => document.querySelector(sel);
      const setText = (el, text, cls) => { el.textContent = text || ""; el.className = "msg" + (cls ? " " + cls : ""); };

      // Validation helpers
      const fields = ["nom","cognoms","dni","adreca"];
      const msgs = { nom: $("#msg-nom"), cognoms: $("#msg-cognoms"), dni: $("#msg-dni"), adreca: $("#msg-adreca") };
      const inputs = { nom: $("#nom"), cognoms: $("#cognoms"), dni: $("#dni"), adreca: $("#adreca") };
      const btnGen = $("#btnGen");
      const btnDl = $("#btnDl");
      const status = $("#status");
      const postGen = $("#postGen");
      const toast = $("#toast");

      const dniOk = (v) => {
        const t = v.trim().toUpperCase();
        if (!t) return false;
        
        // DNI validation
        const dniMatch = t.match(/^([0-9]{8})([A-Z])$/);
        if (dniMatch) {
          const numbers = parseInt(dniMatch[1]);
          const letter = dniMatch[2];
          const expectedLetter = 'TRWAGMYFPDXBNJZSQVHLCKE'[numbers % 23];
          return letter === expectedLetter;
        }
        
        // NIE validation
        const nieMatch = t.match(/^([XYZ])([0-9]{7})([A-Z])$/);
        if (nieMatch) {
          const prefix = nieMatch[1];
          const numbers = parseInt(nieMatch[2]);
          const letter = nieMatch[3];
          const prefixNumbers = { 'X': 0, 'Y': 1, 'Z': 2 };
          const fullNumber = prefixNumbers[prefix] * 10000000 + numbers;
          const expectedLetter = 'TRWAGMYFPDXBNJZSQVHLCKE'[fullNumber % 23];
          return letter === expectedLetter;
        }
        
        return false;
      };

      function validate(show= false){
        let ok = true;
        fields.forEach((f) => {
          const v = inputs[f].value.trim();
          const good = f === "dni" ? dniOk(v) : v.length > 0;
          if (!good) ok = false;

          if (show){
            if (!good){
              inputs[f].setAttribute("aria-invalid","true");
              const errorMsg = f === "dni" ? "DNI o NIE no vàlid" : "Camp obligatori";
              setText(msgs[f], errorMsg, "err");
              inputs[f].style.borderColor = "var(--error)";
              inputs[f].style.boxShadow = "0 0 0 4px rgba(239, 68, 68, .2)";
            } else {
              inputs[f].setAttribute("aria-invalid","false");
              setText(msgs[f], "✔︎ Correcte", "ok");
              inputs[f].style.borderColor = "#d1d5db";
              inputs[f].style.boxShadow = "none";
            }
          }
        });
        btnGen.disabled = !ok;
        return ok;
      }

      function toastMsg(text){
        toast.textContent = text;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2200);
      }

      function formatDateValencia(){
        const d = new Date();
        const mesos = ["gener","febrer","març","abril","maig","juny","juliol","agost","setembre","octubre","novembre","desembre"];
        const m = mesos[d.getMonth()];
        const needsApos = (m === "abril" || m === "agost" || m === "octubre");
        const prep = needsApos ? "d’" : "de ";
        return `${d.getDate()} ${prep}${m} de ${d.getFullYear()}`;
      }

      function buildPdf(){
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        const marginX = 56;
        const marginTop = 56;
        const lineH = 16;
        let y = marginTop;

        // Heading
        doc.setFont(undefined, "bold");
        doc.setFontSize(14);
        const title = "AL·LEGACIONS AL PROCEDIMENT DE CANVI DE DENOMINACIÓ DEL MUNICIPI DE VALÈNCIA";
        const titleLines = doc.splitTextToSize(title, 482);
        doc.text(titleLines, marginX, y);
        y += titleLines.length * (lineH + 2) + 8;

        // Header block
        doc.setFontSize(11);
        doc.setFont(undefined, "normal");
        const head = [
          `Interessat/da: ${inputs.nom.value.trim()} ${inputs.cognoms.value.trim()}`,
          `DNI/NIF: ${inputs.dni.value.trim()}`,
          `Domicili a efectes de notificació: ${inputs.adreca.value.trim()}`,
          ""
        ];
        head.forEach((line)=>{
          if (y > 770) { doc.addPage(); y = marginTop; }
          doc.text(line, marginX, y); y += lineH + 2;
        });

        // EXPOSA section header
        doc.setFont(undefined, "bold");
        if (y > 770) { doc.addPage(); y = marginTop; }
        doc.text("EXPOSA:", marginX, y); y += lineH + 4;

        // Content sections
        doc.setFont(undefined, "normal");
        const exposaParagraph = "La proposta de canvi de denominació oficial contradiu informes tècnics, vulnera clarament la normativa i la legalitat municipal i autonòmica vigent i no respon a cap necessitat real ni lingüística ni social. Lluny de reforçar la convivència, genera divisió i crispació en un àmbit on no existia conflicte real, i suposa una despesa econòmica injustificada tant per a les administracions com per a la ciutadania.";
        
        const exposaLines = doc.splitTextToSize(exposaParagraph, 482);
        exposaLines.forEach((line)=>{
          if (y > 770) { doc.addPage(); y = marginTop; }
          doc.text(line, marginX, y); y += lineH + 2;
        });

        y += 4; // Extra space before next section
        
        const introText = "Així, en relació amb l'anunci del B.O.P sobre el canvi de denominació del municipi de València publicat el 11/8/2025, l'acord adoptat pel Ple de l'Ajuntament de València, de data 26 de setembre de 2023, pel qual s'iniciava el procediment per a modificar la denominació oficial del municipi de \"València\" per la forma \"Valencia/Valéncia\" amb continuïtat en l'expedient E-01304-2025-000005-00, formule les següents";
        
        const introLines = doc.splitTextToSize(introText, 482);
        introLines.forEach((line)=>{
          if (y > 770) { doc.addPage(); y = marginTop; }
          doc.text(line, marginX, y); y += lineH + 2;
        });

        y += 8; // Extra space before AL·LEGACIONS

        // AL·LEGACIONS section header
        doc.setFont(undefined, "bold");
        if (y > 770) { doc.addPage(); y = marginTop; }
        doc.text("AL·LEGACIONS", marginX, y); y += lineH + 6;

        // Allegation points
        doc.setFont(undefined, "normal");
        const allegations = [
          "• El municipi de València es troba en zona de predomini lingüístic valencià i no es justifica legalment el canvi.\nSegons la disposició addicional segona de la Llei 4/1983, d'Ús i Ensenyament del Valencià, la ciutat de València forma part del territori de predomini lingüístic valencià. El Decret 69/2017, de 2 de juny, del Consell, permet que la denominació oficial siga exclusivament en valencià en este cas, sent el camí natural que bona part dels municipis estan adoptant d'acord amb l'especial atenció cap a la recuperació de la llengua pròpia que li procura la legislació vigent.",
          
          "• La proposta de l'Ajuntament de València incompleix el Decret 69/2017 en l'ordre de les formes\nEl Decret 69/2017, en el seu article 4.3, establix que: \"En el cas que la denominació siga bilingüe, la forma en valencià figurarà en primer lloc en el cas de municipis situats en zones de predomini lingüístic valencià.\" La proposta \"Valencia/Valéncia\" incompleix este article, anteposant la forma en castellà a la valenciana.",
          
          "• El canvi del topònim vulnera el Reglament municipal d'ús del valencià\nEl Reglament d'ús del valencià de l'Ajuntament de València establix en el seu article 16.1: \"Tots els topònims del terme municipal tenen com a forma oficial la valenciana, que és la tradicional, la històrica i la correcta.\"",
          
          "• Cap informe a l'expedient argumenta el canvi més enllà d'aspectes ortogràfics\nL'únic informe lingüístic present en l'expedient és l'estudi d'Abelard Saragossà, que es limita a proposar un canvi ortogràfic sense defensar la forma bilingüe.",
          
          "• El canvi és lingüísticament innecessari i redundant\nEl doblet \"Valencia/Valéncia\" és completament redundant, ja que l'única diferència és un accent i la forma actual \"València\" és perfectament entesa per tota la població.",
          
          "• Un canvi estrictament polític i sense consens social\nEl canvi s'impulsa des de l'àmbit polític, al marge dels mecanismes normatius establerts i d'esquena a l'Acadèmia Valenciana de la Llengua.",
          
          "• El canvi pot comportar una despesa milionària i innecessària\nModificar la denominació obligaria a canviar tota la retolació urbana, amb un cost econòmic molt elevat sense benefici col·lectiu clar.",
          
          "• La forma \"València\" és la legal i vigent\nLa forma \"València\" va ser establida pel Decret 16/2017 amb informe favorable de l'Acadèmia Valenciana de la Llengua, dins d'un procediment plenament legal.",
          
          "• El canvi genera incoherència institucional\nMentre es proposa modificar el nom del municipi, altres institucions mantindran la forma \"València\", creant dissonància institucional.",
          
          "• El canvi suposa una regressió en la normalització del valencià\nModificar la forma \"València\" per una denominació duplicada suposa un retrocés simbòlic en termes de dignitat lingüística."
        ];

        allegations.forEach((allegation) => {
          const allegationLines = doc.splitTextToSize(allegation, 482);
          allegationLines.forEach((line)=>{
            if (y > 770) { doc.addPage(); y = marginTop; }
            doc.text(line, marginX, y); y += lineH + 2;
          });
          y += 4; // Extra space between allegations
        });

        y += 8; // Extra space before SOL·LICITE

        // SOL·LICITE section header
        doc.setFont(undefined, "bold");
        if (y > 770) { doc.addPage(); y = marginTop; }
        doc.text("SOL·LICITE:", marginX, y); y += lineH + 4;

        // Final solicitation
        doc.setFont(undefined, "normal");
        const solicitation = "Que es tinguen per presentades estes al·legacions i, en conseqüència, es desestime la proposta de canvi de denominació del municipi de València per la forma dual \"Valencia/Valéncia\", mantenint-se la forma oficial en valencià per ser la legalment establerta, coherent, eficient, lingüísticament fixada, i -com el propi reglament municipal diu- històrica i correcta: \"València\" en valencià.";
        
        const solicitationLines = doc.splitTextToSize(solicitation, 482);
        solicitationLines.forEach((line)=>{
          if (y > 770) { doc.addPage(); y = marginTop; }
          doc.text(line, marginX, y); y += lineH + 2;
        });

        y += 8; // Space before closing

        // Closing with fixed location
        const closing = "A València, 26 d'agost de 2025";
        if (y > 770) { doc.addPage(); y = marginTop; }
        doc.text(closing, marginX, y);

        // Blob + download URL
        const blob = doc.output("blob");
        const url = URL.createObjectURL(blob);
        return url;
      }

      // Bindings
      fields.forEach((f)=>{
        inputs[f].addEventListener("input", () => validate(false));
        inputs[f].addEventListener("blur", () => validate(true));
      });

      $("#form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const ok = validate(true);
        if (!ok){
          const firstBad = fields.find((f)=> (f==="dni" ? !dniOk(inputs[f].value) : inputs[f].value.trim().length === 0));
          if (firstBad){ inputs[firstBad].focus(); inputs[firstBad].scrollIntoView({behavior:"smooth", block:"center"}); }
          toastMsg("Revisa els camps marcats en roig");
          return;
        }
        status.textContent = "Generant PDF…";
        // Ensure jsPDF loaded
        const tryBuild = () => {
          if (!window.jspdf || !window.jspdf.jsPDF){ return setTimeout(tryBuild, 50); }
          const url = buildPdf();
          btnDl.href = url;
          // Set custom filename based on user's name
          const fileName = `Allegacio_${inputs.nom.value.trim().replace(/\s+/g, '_')}.pdf`;
          btnDl.download = fileName;
          btnDl.style.display = "inline-flex";
          btnDl.click(); // autodescarrega
          
          // Hide form and show success message
          $("#form").style.display = "none";
          $("h1").style.display = "none";
          // Hide description paragraphs specifically
          $("#desc1").style.display = "none";
          $("#desc2").style.display = "none";
          status.textContent = "";
          postGen.style.display = "block";
          toastMsg("PDF generat i baixat!");
        };
        tryBuild();
      });
    </script>
  </body>
</html>
